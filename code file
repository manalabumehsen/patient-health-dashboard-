import pandas as pd
import matplotlib.pyplot as plt
import sqlite3

# Ø¥Ù†Ø´Ø§Ø¡ DataFrame ÙØ§Ø±Øº
df = pd.DataFrame(columns=["Name", "Age", "Gender", "Weight", "Height", 
                           "Blood_Pressure", "Sugar", "BMI", "BMI_Category"])

# Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ BMI ÙˆØªØµÙ†ÙŠÙ Ø§Ù„ÙˆØ²Ù†
def calculate_bmi(weight, height):
    bmi = weight / (height ** 2)
    if bmi < 18.5:
        category = "Ù†Ù‚Øµ ÙˆØ²Ù†"
    elif bmi < 25:
        category = "ÙˆØ²Ù† Ø·Ø¨ÙŠØ¹ÙŠ"
    elif bmi < 30:
        category = "Ø²ÙŠØ§Ø¯Ø© ÙˆØ²Ù†"
    else:
        category = "Ø³Ù…Ù†Ø©"
    return bmi, category

def main_menu():
    while True:
        print("\n--- Ù…Ù†ÙŠÙˆ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ---")
        print("1. Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯")
        print("2. Ø¹Ø±Ø¶ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ")
        print("3. Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©")
        print("4. Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø®Ø±ÙˆØ¬")
        print("5. Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª SQL")

        choice = input("Ø§Ø®ØªÙŠØ§Ø±Ùƒ (1-5): ")

        if choice == "1":
            add_patient()
        elif choice == "2":
            show_statistics()
        elif choice == "3":
            show_charts()
        elif choice == "4":
            save_and_exit()
            break
        elif choice == "5":
            sql_menu()
        else:
            print("âŒ Ø®ÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­ØŒ Ø¬Ø±Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")

def add_patient():
    try:
        name = input("Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶: ")
        age = int(input("Ø§Ù„Ø¹Ù…Ø±: "))
        gender = input("Ø§Ù„Ø¬Ù†Ø³ (M/F): ")
        weight = float(input("Ø§Ù„ÙˆØ²Ù† (kg): "))
        height = float(input("Ø§Ù„Ø·ÙˆÙ„ (m): "))
        bp = float(input("Ø¶ØºØ· Ø§Ù„Ø¯Ù…: "))
        sugar = float(input("Ù†Ø³Ø¨Ø© Ø§Ù„Ø³ÙƒØ±: "))

        bmi, category = calculate_bmi(weight, height)
        df.loc[len(df)] = [name, age, gender, weight, height, bp, sugar, bmi, category]
        print("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­")
    except ValueError:
        print("âŒ Ø®Ø·Ø£: Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (Ø£Ø±Ù‚Ø§Ù…).")

def show_statistics():
    if df.empty:
        print("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.")
        return

    print("\n--- Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ ---")
    print("Ù…ØªÙˆØ³Ø· Ø¶ØºØ· Ø§Ù„Ø¯Ù…:", df["Blood_Pressure"].mean())
    print("Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³ÙƒØ±:", df["Sugar"].mean())
    print("Ù…ØªÙˆØ³Ø· BMI:", df["BMI"].mean())
    print("Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…Ø¹ÙŠØ§Ø±ÙŠ Ù„Ù„Ù€ BMI:", df["BMI"].std())

    abnormal = df[(df["Blood_Pressure"] > 140) | (df["Sugar"] > 120)]
    if not abnormal.empty:
        print("\nâš ï¸ Ù…Ø±Ø¶Ù‰ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ:")
        print(abnormal[["Name", "Blood_Pressure", "Sugar"]])
    else:
        print("ğŸ‘Œ ÙƒÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ.")

def show_charts():
    if df.empty:
        print("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.")
        return

    df["Blood_Pressure"].hist()
    plt.title("ØªÙˆØ²ÙŠØ¹ Ø¶ØºØ· Ø§Ù„Ø¯Ù…")
    plt.show()

    df["Sugar"].hist()
    plt.title("ØªÙˆØ²ÙŠØ¹ Ù†Ø³Ø¨Ø© Ø§Ù„Ø³ÙƒØ±")
    plt.show()

    df["BMI"].hist()
    plt.title("ØªÙˆØ²ÙŠØ¹ BMI")
    plt.show()

    df["BMI_Category"].value_counts().plot.pie(autopct="%1.1f%%")
    plt.title("Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø­Ø³Ø¨ ÙØ¦Ø§Øª BMI")
    plt.show()

    plt.scatter(df["Blood_Pressure"], df["Sugar"], c=(df["Gender"]=="M"), cmap="bwr")
    plt.xlabel("Ø¶ØºØ· Ø§Ù„Ø¯Ù…")
    plt.ylabel("Ù†Ø³Ø¨Ø© Ø§Ù„Ø³ÙƒØ±")
    plt.title("Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø¨ÙŠÙ† Ø¶ØºØ· Ø§Ù„Ø¯Ù… ÙˆÙ†Ø³Ø¨Ø© Ø§Ù„Ø³ÙƒØ± Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù†Ø³")
    plt.show()

def save_and_exit():
    df.to_csv("patients_data.csv", index=False)
    print("ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù…Ù„Ù patients_data.csv")
    print("ğŸ‘‹ ÙˆØ¯Ø§Ø¹Ø§Ù‹")

def sql_menu():
    if df.empty:
        print("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.")
        return

    conn = sqlite3.connect("patients.db")
    cursor = conn.cursor()

    cursor.execute("""
    CREATE TABLE IF NOT EXISTS patients (
        Name TEXT,
        Age INTEGER,
        Gender TEXT,
        Weight REAL,
        Height REAL,
        Blood_Pressure REAL,
        Sugar REAL,
        BMI REAL,
        BMI_Category TEXT
    )
    """)

    df.to_sql("patients", conn, if_exists="replace", index=False)

    while True:
        print("\n--- Ù…Ù†ÙŠÙˆ SQL ---")
        print("1. Ù…ØªÙˆØ³Ø· Ø¶ØºØ· Ø§Ù„Ø¯Ù…")
        print("2. Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø­Ø³Ø¨ ÙØ¦Ø© BMI")
        print("3. Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø¹Ù†Ø¯Ù‡Ù… Ø¶ØºØ· Ø¯Ù… Ø£Ùˆ Ø³ÙƒØ± Ù…Ø±ØªÙØ¹")
        print("4. Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©")

        sql_choice = input("Ø§Ø®ØªÙŠØ§Ø±Ùƒ (1-4): ")

        if sql_choice == "1":
            cursor.execute("SELECT AVG(Blood_Pressure) FROM patients")
            print("Ù…ØªÙˆØ³Ø· Ø¶ØºØ· Ø§Ù„Ø¯Ù…:", cursor.fetchone()[0])
        elif sql_choice == "2":
            cursor.execute("SELECT BMI_Category, COUNT(*) FROM patients GROUP BY BMI_Category")
            print("\nØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø­Ø³Ø¨ ÙØ¦Ø© BMI:")
            for row in cursor.fetchall():
                print(row)
        elif sql_choice == "3":
            cursor.execute("SELECT Name, Blood_Pressure, Sugar FROM patients WHERE Blood_Pressure > 140 OR Sugar > 120")
            print("\nÙ…Ø±Ø¶Ù‰ Ø¹Ù†Ø¯Ù‡Ù… Ø¶ØºØ· Ø¯Ù… Ø£Ùˆ Ø³ÙƒØ± Ù…Ø±ØªÙØ¹:")
            for row in cursor.fetchall():
                print(row)
        elif sql_choice == "4":
            break
        else:
            print("âŒ Ø®ÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­ØŒ Ø¬Ø±Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")

    conn.close()

if __name__ == "__main__":
    main_menu()